# to install
#
# helm repo add kubernetes-dashboard https://kubernetes.github.io/dashboard/
# helm upgrade --install kubernetes-dashboard kubernetes-dashboard/kubernetes-dashboard --create-namespace --namespace kubernetes-dashboard

---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: admin-user
  namespace: kubernetes-dashboard


---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: admin-user
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cluster-admin
subjects:
- kind: ServiceAccount
  name: admin-user
  namespace: kubernetes-dashboard


# long-lived token so that we can have browser remember it
# (cmd to fetch token for login below)
---
apiVersion: v1
kind: Secret
metadata:
  name: admin-user
  namespace: kubernetes-dashboard
  annotations:
    kubernetes.io/service-account.name: "admin-user"   
type: kubernetes.io/service-account-token


# opens an ingress to the same service that the demo/setup docs for the
# dashboard proxies to:
#
#   kubectl -n kubernetes-dashboard port-forward \
#     svc/kubernetes-dashboard-kong-proxy 8443:443
#
# allows you to go to
#
#   https://home.k8s:<ingress-nginx NodePort HTTPS port>
#
# to access the dashboard
#
# NOTE: home.k8s is present so nginx filters/serves based on domain name
#       I created local DNS entries in pihole that point to all of my nodes to
#       make this work. I also patch the NodePort svc for the
#       nginx-ingress-controller to ensure a static port on all setups
#
# token to login:
#   kubectl get secret admin-user -n kubernetes-dashboard -o jsonpath={".data.token"} | base64 -d
#
# for more info on the nginx annotations:
#   https://github.com/kubernetes/ingress-nginx/blob/main/docs/user-guide/nginx-configuration/annotations.md
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  annotations:
    nginx.ingress.kubernetes.io/backend-protocol: "HTTPS"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    nginx.ingress.kubernetes.io/ssl-passthrough: "true"
  name: dashboard-ingress
  namespace: kubernetes-dashboard
spec:
  ingressClassName: nginx
  rules:
    - host: dashboard.home.k8s
      http:
        paths:
        - path: /
          pathType: Prefix
          backend:
            service:
              name: kubernetes-dashboard-kong-proxy
              port:
                name: kong-proxy-tls
