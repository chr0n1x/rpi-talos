repositories:
  - name: k8s-dashboard
    url: https://kubernetes.github.io/dashboard/

  - name: grafana
    url: https://grafana.github.io/helm-charts

  - name: prometheus
    url: https://prometheus-community.github.io/helm-charts

  - name: descheduler
    url: https://kubernetes-sigs.github.io/descheduler/

  - name: homepage
    url: https://jameswynn.github.io/helm-charts

releases:
  - name: ingress-nginx
    namespace: ingress-nginx
    chart: kustomize/nginx
    hooks:
      - events:
          - cleanup
        command: kubectl
        args:
          - apply
          - --recursive
          - -f
          - manifests/post-install-configurations

  - name: oauth2-proxy
    namespace: oauth2-proxy
    chart: ./helm/oauth2-proxy
    createNamespace: true
    values:
      - helmfile/oauth2-proxy.gotmpl
    hooks:
      - events:
          - prepare
        command: rm
        args:
          - helm/oauth2-proxy/Chart.lock

  - name: smb-csi
    namespace: kube-system
    chart: ./helm/smb-csi
    values:
      - helmfile/smb-csi.gotmpl
    hooks:
      # https://github.com/helm/helm/issues/8036
      - events:
          - prepare
        command: rm
        args:
          - helm/smb-csi/Chart.lock
      - events:
          - presync
        command: bash
        args:
          - -c
          - "kubectl delete StorageClass smb || echo 'no smb StorageClass found'"

  - name: longhorn
    namespace: longhorn-system
    createNamespace: true
    chart: ./helm/longhorn
    needs:
      - ingress-nginx/ingress-nginx
    values:
      - helmfile/longhorn-values.gotmpl
    hooks:
      - events:
          - cleanup
        command: kubectl
        args:
          - label
          - namespace
          - longhorn-system
          - pod-security.kubernetes.io/enforce=privileged
      - events:
          - cleanup
        command: kubectl
        args:
          - label
          - StorageClass
          - longhorn
          - storageclass.kubernetes.io/is-default-class=true

  # for more info on default installation:
  #   https://github.com/kubernetes-sigs/descheduler/blob/master/charts/descheduler/README.md
  - name: descheduler
    namespace: kube-system
    chart: descheduler/descheduler

  - name: prometheus
    namespace: monitoring
    createNamespace: true
    chart: prometheus/prometheus
    needs:
      - longhorn-system/longhorn
      - ingress-nginx/ingress-nginx
    values:
      - persistence:
          enabled: true
          storageClassName: longhorn
          # TODO: somehow find-or-create longhorn pvc?
          # existingClaim: prometheus-pvc
          accessModes:
            - ReadWriteMany
      - prometheus-node-exporter:
          rbac:
            create: true
      - rbac:
          create: true
          podSecurityPolicy:
            enabled: true
    hooks:
      # required for node-exporter metrics
      - events:
          - presync
        command: bash
        args:
          - -c
          - "kubectl delete --namespace monitoring deployment prometheus-server || echo 'No prometheus-server found'"
      # required for node-exporter metrics
      - events:
          - cleanup
        command: kubectl
        args:
          - label
          - namespace
          - monitoring
          - pod-security.kubernetes.io/enforce=privileged

  - name: grafana
    chart: grafana/grafana
    version: ~8.3.2
    namespace: monitoring
    createNamespace: true
    needs:
      - monitoring/prometheus
      - longhorn-system/longhorn
      - ingress-nginx/ingress-nginx
    values:
      # this just started to fail one day, no idea
      - initChownData:
          enabled: false
      - persistence:
          enabled: true
          storageClassName: longhorn
          # TODO: somehow find-or-create longhorn pvc?
          # existingClaim: grafana-pvc
          accessModes:
            - ReadWriteMany
      - datasources:
          datasources.yaml:
            apiVersion: 1
            datasources:
            - name: Prometheus
              type: prometheus
              url: http://prometheus-server

  - name: kubernetes-dashboard
    namespace: kubernetes-dashboard
    createNamespace: true
    chart: k8s-dashboard/kubernetes-dashboard
    version: ~7.5.0
    # if you're not running too many things comment this out
    values:
      - api:
          role: api
          containers:
            resources:
              requests:
                memory: 1Gi
              limits:
                memory: 2Gi

  - name: homepage
    namespace: homepage
    chart: kustomize/homepage
    createNamespace: true
    hooks:
      - events:
          - cleanup
        command: kubectl
        args:
          - --namespace
          - homepage
          - rollout
          - restart
          - deployment
          - homepage

  - name: docker-registry
    namespace: docker-registry
    chart: kustomize/docker-registry
    needs:
      - longhorn-system/longhorn
      - ingress-nginx/ingress-nginx
